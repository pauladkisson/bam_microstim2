# bam_microstim
This projects adds microstimulation to the Wang 2002 Biophysical Attractor Model of decision-making.  A conference paper describing this work was recently accepted by the Engineering in Medicine and Biology Society, which can be [here](https://github.com/pauladkisson/bam_microstim/blob/main/embc_2022_PaulAdkisson.pdf). 

## Description of Project Organization
The project is generally run by 4 code scripts:
  1) bam_constants.m defines all the necessary constants, generates connectivities/neuron locations/stimulation conditions for a given simulation.
  2) main.m runs the main simulation program, which simulates leaky-integrate-and-fire dynamics, synaptic currents, task-related currents, background currents, and microstimulation currents for a variety of task conditions (coherences) and microstimulation inputs.  Spike times for each neuron are stored in a containers.map variable called ``recspikes`` in .mat files.
  3) analyze_main.m runs analysis of the raw spike time data to generate data of interest such as accuracy and decision time, and stores them in "decisions.mat" files.
  4)  plot_results.m plots the data generated by analyze_main.m, in a variety of visualizations. each of which calls various functions.

The data is stored in a different folder for each simulation ("Simulation X"), which is determined by the ``sim_name`` variable defined in bam_constants.m.    

## How to use
- Define name of simulation with ``sim_name`` variable in bam_constants.m (ex. "X")
- Adjust parameters as necessary
- Call bam_constants --> saves necessary constants
- Update ``sim_name`` in main.m
- Call main.m --> for each brain/stimulation condition/coherence/trial, saves data in "Simulation X/brainY/data/``stim_amp``nA_*stim_cond*/c=*coherence*/trialZ.mat"
- Update ``sim_name`` in analyze_main.m
- Set ``reconstruct = true`` to reconstruct instaneous population firing rates (``pop_frs``) from spike times (``recspikes``)
- Call analyze_main --> saves analyzed variables in "Simulation X/brainY/data/``stim_amp``nA*stim_cond*/decisions.mat"
- Update ``sim_name`` in plot_results.m
- Uncomment whichever plotting section you want to visualize
- Call plot_results --> visualizes data

## Data Storage
Data is stored in an organized nested folder structure with the following levels
- Simulation name ("Simulation Test"), which contains
    - conductances.mat, which stores matrices with connection conductances for ampa (``AMPA``), gaba (``GABA``), nmda (``NMDA``) synapses
    - bam_constants.mat, which stores a variety of useful constants
    - adja.mat, which stores connection adjacency matrix ``adja``
    - spikes, which contains the task-related and background input spikes for each trial/coherence under
      - c=*coherence* (ex. "c=-1.000")
        - trialX.mat (ex. "trial1.mat")
          - input.mat, which contains a variable with all the input spikes called ``spikes``
    - brainX (ex "brain1"), which contains all the nested data/constants for a given brain
      - r.mat, which stores the locations of each P1 neuron (``ball_r``), and their effective electrical distance (``electric_r``)
      - ustim, which contains the stimulation currents for each of the stimulation condition
        - ``stim_amp``nA*stim_cond*.mat (ex. "-28.0nA_galvanic.mat"), which stores the instantaneous microstimulation current for each neuron (``I_ustim``)
      - data, which contains the data for each trial in a nested structure
        - ``stim_amp``nA_*stim_cond* (ex. "-28.0nA_galvanic") for each stimulation condition
          - decisions.mat, which stores all of the analyzed variables from analyze_main.m
          - c=*coherence* ex. ("c=-1.000") for each coherence
            - trialX.mat (ex. "trial1.mat"), which stores the spike times for each neuron in a containers.map variable (``recspikes``),
                  in which the keys are the neuron number as a string (ex. ``'1'``) and the values are a vector containing the time indices
                  when the neuron fired an action potential (ex. ``t(recspikes('1')) = [0.521, 1.001, 2.325, 2.9, 2.997, 3.053]``).  It also stores the
                  instaneous population firing rates for each neuron (``pop_frs``) after analyze_main.m has been run with ``reconstruct = true``.
                  

## Detailed Description of 4 main scripts and subsidiary functions
### bam_constants.m
  Define constants, input currents, brain architecture, etc.
#### Simulation Parameters
  - ``sim_name`` : name of simulation
  - ``sim_path`` : folder name for simulation
  - ``dt`` : time step for euler's integration
  - ``t_span`` : duration of simulation (s)
  - ``start_trial`` : first trial to run
  - ``end_trial`` : last trial to run

#### Network Parameters
  - Total number of neurons in the network ``N = 2000 * percent_size = N_E + N_I``; where ``N_E`` is the number of excitatory neurons and ``N_I`` is the number of inhibitory neurons
  - ``f`` : fraction of cortical neurons affected by one type of stimulus (``(1-f)*N_E`` is the number of non-selective excitatory neurons)
  - ``p`` : Number of different types of stimuli i.e. number of selective neuron groups
  - ``num_selective`` : Number of selective neurons (P1 and P2)
  - ``num_group`` : Number of neurons in one group (ex. P1)
  - ``w_plus, w_minus, w`` : Strength of 'strong', 'weak', and normal synapses in the BAM
  - ``start_brain, end_brain`` : first and last brain to run in a simulation
  - ``pop_type`` : vector recording type of each neuron (1 for excitatory, 2 for inhibitory)
  - GenerateBAM
    - Creates adjacency matrix ``adja`` and saves to "Simulation X/adja.mat"
    - Positions neurons at regularly spaced intervals (+ random jitter) and saves positions as ``ball_r`` in "Simulation X/brainY/r.mat"
    - Tests results by plotting microstimulation currents for each neuron for an extracellular test current (``pulse_test_stim, galvanic_test_stim``)
  - GenerateBAM_NoRecX : The same as GenerateBAM except without recurrent excitation connections
  - GenerateConductances
    - Creates conductance matrices ``AMPA, NMDA, GABA`` and saves to "Simulation X/conductances.mat"
#### Input Parameters
  - ``fr_bg`` : background input firing rate
  - ``G_ampa_ext`` : maximum external ampa conductance (siemens)
  - ``pulse_coherences, control_coherences, galvanic_coherences`` : coherence values for pulse, control, and galvanic stimulation conditions
  - ``max_fr_task`` : maximum task-related input firing rate
  - ``t_task`` : time that the task (and microstimulation) begin (s)
  - ``t_taskoff`` : time that task (and microstimulation) end (s)
  - GenerateSpikes
    - Creates matrix recording background and task-related input spikes for each neuron (size = length(t) x N) : ``spikes``
    - Saves ``spikes`` in appropriate location for each coherence/trial : "Simulation X/spikes/c=*coherence*/trialY/input.mat"
#### Microstimulation Parameters
  - ``stim_duration`` : duration of pulse (s/phase)
  - ``stim_ind`` : time of full pulse presentation (two phases) in terms of time index
  - ``pulse_amps`` : amplitude(s) of pulse stimulation
  - ``stim_freq`` : pulse stimulation frequency (Hz)
  - ``dc_amps`` : galvanic stimulation amplitude(s)
  - ``stim_amps`` : ``[pulse_amps, dc_amps]``
  - GenerateMicrostim
    - Creates microstimulation current ``I_ustim`` (size = length(t) x N) for each neuron and timepoint
    - Saves ``I_ustim`` in appropriate location for each brain : "SimulationX/brainY/ustim/``stim_amp``nA_*stim_cond*.mat"
#### Firing Rate Parameters
  - ``win_size`` : window size for calculating instaneous firing rate
  - ``win_index`` : discretized ``win_size``
  - ``avg_win_size`` : window size for moving average of instaneous firing rate
  - ``avg_win_index`` : discretized ``avg_win_size``
#### t_b
  - ``t_b`` : general blocking times and current amplitudes from vestibular axon model
  - ``best_tref_per_c`` : vector containing pulse-pulse, pulse-spontaneous, and spontaneous-pulse blocking times from vestibular axon model
  - ``t_pp`` : pulse-pulse blocking times
  - ``t_ps`` : pulse-spontaneous blocking times
  - ``I_b`` : blocking pulse amplitudes fitted to the LIF model
#### Save
  - saves all constants in "Simulation X/bam_constants.mat"


### main.m
  - Loads various constants from bam_constants.mat, as well as adjacency matrices and conductance matrices
  - Iterate through each brain, stimulation condition, coherence, and trial
  - Load input spikes ``spikes`` and microstimulation current ``I_ustim``
#### LIF variables
  - ``RP_ind`` : remaining refractory indices for each neuron (decrements every time step)
  - ``RP_pp_ind`` : remianing pulse-pulse blocking refractory indices for each neuron
  - ``RP_ps_ind`` : remaining pulse-spontaneous blocking refractory indicies for each neuron
  - ``Vm`` : membrane potential for each neuron (volts)
  - ``s_ampa`` : dynamical ampa synapse variable
  - ``s_ampa_ext`` : dynamical external ampa synapse variable
  - ``s_nmda`` : dynamical nmda synapse variable
  -  ``x_nmda`` : 2nd dynamical nmda synapse variable
  - ``s_gaba`` : dynamical gaba synapse variable
#### Synpatic Current
  - ``I_ch`` : 'channel' current for the current time step
  - ``V_ch`` : 'channel' voltage for the current time step
  - ``*_ch`` : the 'channel' version of any variable indexed for the current (or delayed) time step only
  - synapse_current
    - Calculates AMPA, NMDA, and GABA synaptic currents for each neuron : returns ``I``
#### External input
  - If there is an external spike in ``spikes`` increment external dynamical ampa synapse variable ``s_ampa_ext``
#### Spiking behavior
  - if any neurons have membrane potential > ``Vs``,
    - draw the spike
    - reset membrane potential to ``Vr``
    - reset refractory index ``RP_ind``
    - increment dynamical synapse variables ``s_ampa, x_nmda, s_gaba``
#### Synapse Update
  - Update synapse variables according to euler's method
#### Pulse Blocking Effects
  - if the stimulation condition is pulse,
    - For the neurons in pulse-pulse block, set the microstimulaiton current ``I_ustim`` to 0 
    - For the neurons in pulse-spontaneous block, set the synaptic/external current ``I_ch`` to 0
#### Voltage update
  - Update membrane potential according to euler's method
#### pulse refractory
  - At the end of each pulse, determine which neurons are blocked
  - If not blocked, the pulse-pulse refractory period and pulse-spontaneous refractory periods are determined by simply interpolating with ``t_ps, t_pp`` and ``I_b``
  - If already blocked, the additional pulse-pulse and pulse-spontaneous refractory periods are determined by the same interpolation as above times a correction factor
  - At the end, decrement both blocking periods
#### fast_parsave
  - saves the spiking data into a containers.Map object called ``recspikes`` where the keys are the neuorn numbers (ex. ``'1'``) and the values are the time indices when that neuron spikes.
  - The data is saved in the appropriate filepath: "Simulation X/brainY/data/``stim_amp``nA*stim_condition*/c=*coherence*/trialZ.mat"

### analyze_main.m
- Specify which simulation, stimulation conditions/amplitudes, start and end trials, start and end brains, and coherences  to analyze
- ``reconstruct`` : boolean, whether or not to reconstruct population firing rates ``pop_frs`` from recspikes.  Note: this is a 
      time-intesive process.
- ``logistic_regression``: boolean, whether or not to perform logistic regression on the accuracy data to obtain parameter values
- Iterate through each brain, stimulation condition, coherence, and trial
- ``decisions`` : outcome of each trial (0 for no decision, 1 for P1 wins, 2 for P2 wins) using first-to-threshold method
- ``final_decisions`` : outcome of each trial using winner-at-the-end method
- ``decision_times`` : time when first population exceeds 15Hz for each trial
- ``final_decision_times`` : time when winning population clears 15Hz for each trial using winner-at-the-end method
- ``avg_dts`` : average decision time over all trials at each coherence
- ``std_dts`` : standard deviation of decision times over trials for each coherence
- ``avg_correct_dts, avg_incorrect_dts`` : average decision time over trials for each coherence partitioned by outcome (P1 wins = correct, P1 loses = incorrect)
- ``std_correct_dts, std_incorrect_dts`` : same as above except for standard deviations
- ``avg_acc`` : fraction of trials in which P1 won (first-to-thresh method) for each coherence
- ``avg_final_acc`` : fraction of trials in which P1 won (winner-at-the-end method)
- ``batch_final_acc`` :  final accuracy split into batches of ``batch_size`` trials for variability comparisons
- ``percent_nodec`` : fraction of trials in which no decision was reached (no population firing rates exceeded 15Hz)
- ``percent_earlydec`` : fraction of trials in which a decision was reached before the task related stimulation started (``t=t_task``)
- ``tot_frs`` : a convenience variable that has all population firing rates across all coherences and trials
- ``avg_correct_frs, std_correct_frs, avg_nodec_frs, avg_earlydec_frs, avg_incorrect_frs, etc.`` : instaneous population firing rates and standard deviations partitioned by outcome (correct, incorrect, no decision, early decision)
- ``avg_correct_peaks, std_incorrect_peaks, etc.`` : average and standard deviation of the maximum population firing rate of each trial partitioned by outcome
- ``dec_thresholds_lb, dec_thresholds_ub`` : true decision threshold determined by the maximum firing rate achieved by losing populations (lower bound) and the minimum firing rate achieved by winning populations (upper bound)
- ``totspikes_g1, totspikes_g2, etc.`` : the total number of spikes fired by each neuron in each trial for a given subpopulation (g1 = P1, g2 = P2, etc.)
- get_decision
  - first-to-threshold method of determining the winner of a trial
  - whichever subpopulation clears 15Hz first is deemed the winner, and that time is called the decision time
- get_final_decision
  - winner-at-the-end method of determining the winner of a trial
  - whichever subpopulation has the higher average firing rate at the end the of the trial (``t = t_span``) is deemed the winner (as long as it is also above 15Hz). Then, the time when that subpopulation cleared 15Hz is deemed the decision time.

### plot_results.m
- define simulation name, trials/coherences/brains/etc. to plot
- plot_frs : visualizes example trial of population-averaged firing rates
- plot_rasters : visualizes example trial of individual neuron raster plots for specified neurons (``ex_neurons``)
- plot_cv : visualizes coefficient of variation for example trials (if ``plot_name = 'ex_trials'``) or averaged across trials for a given outcome specification (if ``plot_name = 'p1_wins' or 'p1_loses'``)
  - also displays statistics from 2-way t-test
- plot_phaselock : visualizes phase locking of P1 to pulse stimulation input averaged across trials, and compares connected and disconnected cases
  - also shows results of 2-way t-test
- plot_sync : visualizes synchrony of P1 in different stimulation conditions
  - also shows results of 2-way t-test
- plot_frdist : visualizes distribution of total average firing rates of P1 as it varies with distance from the electrode for different stimulation conditions
  - also shows results of 2-way t-test
- plot_decisions : visualizes accuracy and decision time vs coherence for different stimulation conditions
  - also shows the resulting curve from fitting the data to logistic regression function
  - also shows results of 2-way t-test
